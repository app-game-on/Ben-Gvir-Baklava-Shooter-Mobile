<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // Game variables
    let player = { x: 375, y: 500, width: 50, height: 50, speed: 0, dx: 0 };
    let hazards = [];
    let bullets = [];
    let score = 0;
    let gameOver = false;
    let spawnRate = 1000; // Starting spawn rate
    let lastSpawn = 0;
    let isSecondPhase = false; // Tracks if we are in Phase 2
    
    // --- NEW: Immunity Variables ---
    let isImmune = false;
    let immunityTimer = 0;
    // -------------------------------

    // Images
    const playerImg = new Image();
    playerImg.src = 'GoldK.png'; 
    const hazardImg1 = new Image();
    hazardImg1.src = 'FirstOrder.png'; // Phase 1 hazard
    const hazardImg2 = new Image();
    hazardImg2.src = 'bomb.png';       // Phase 2 hazard
    const bulletImg = new Image();
    bulletImg.src = 'Bible.png';       // Phase 1 bullet
    const bulletImg2 = new Image();
    bulletImg2.src = 'baklava.png';    // Phase 2 bullet

    // Touch controls
    let touchStartX = 0;
    
    canvas.addEventListener("touchstart", (e) => {
        touchStartX = e.touches[0].clientX;
    });

    canvas.addEventListener("touchmove", (e) => {
        let touchX = e.touches[0].clientX;
        let deltaX = touchX - touchStartX;
        player.x += deltaX;
        
        // Keep player in bounds
        if (player.x < 0) player.x = 0;
        if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;
        
        touchStartX = touchX;
        e.preventDefault(); // Stop scrolling
    }, { passive: false });

    // Button Listeners
    document.getElementById("fireBtn").addEventListener("click", shoot);
    document.getElementById("fireBtn").addEventListener("touchstart", (e) => {
        e.preventDefault(); 
        shoot();
    });

    function shoot() {
        if (gameOver) return;
        bullets.push({ 
            x: player.x + player.width / 2 - 15, 
            y: player.y, 
            width: 30, 
            height: 30,
            img: isSecondPhase ? bulletImg2 : bulletImg 
        });
    }

    function spawnHazard() {
        // --- FIX: Edge Safety & Difficulty Cap ---
        
        // 1. Cap the difficulty: Don't let spawnRate go below 400ms
        let currentRate = Math.max(400, 1000 - (score * 0.5)); 
        
        if (Date.now() - lastSpawn > currentRate) {
            // 2. Fix Edges: Allow X to go from -20 to Width+20 so edges aren't safe
            let minX = -20;
            let maxX = canvas.width - 30; // 50 width - 20 overlap
            let randomX = Math.random() * (maxX - minX) + minX;

            hazards.push({
                x: randomX,
                y: -50,
                width: 50,
                height: 50,
                speed: 3 + (score * 0.002), // Speed increases slowly
                img: isSecondPhase ? hazardImg2 : hazardImg1
            });
            lastSpawn = Date.now();
        }
    }

    function update() {
        if (gameOver) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // --- NEW: Handle Phase Switch & Immunity ---
        if (score >= 2500 && !isSecondPhase) {
            isSecondPhase = true;
            
            // Swap Player Image
            playerImg.src = 'photo1.png';
            
            // Trigger Immunity
            isImmune = true;
            setTimeout(() => {
                isImmune = false;
            }, 3000); // 3 Seconds of immunity
        }

        // Draw Player (Blink if immune)
        if (isImmune) {
            // Flicker effect: Only draw every other frame (or use modulo of time)
            if (Math.floor(Date.now() / 100) % 2 === 0) {
                ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
            }
        } else {
            ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
        }
        // -------------------------------------------

        // Update Bullets
        bullets.forEach((b, index) => {
            b.y -= 7;
            ctx.drawImage(b.img, b.x, b.y, b.width, b.height);
            if (b.y < 0) bullets.splice(index, 1);
        });

        // Update Hazards
        spawnHazard();
        hazards.forEach((h, hIndex) => {
            h.y += h.speed;
            ctx.drawImage(h.img, h.x, h.y, h.width, h.height);

            // Collision with Bullets
            bullets.forEach((b, bIndex) => {
                if (
                    b.x < h.x + h.width &&
                    b.x + b.width > h.x &&
                    b.y < h.y + h.height &&
                    b.y + b.height > h.y
                ) {
                    hazards.splice(hIndex, 1);
                    bullets.splice(bIndex, 1);
                    score += 50;
                    document.getElementById("scoreBoard").innerText = "Score: " + score;
                }
            });

            // Collision with Player
            // --- NEW: Check Immunity before killing ---
            if (!isImmune && 
                player.x < h.x + h.width - 10 &&
                player.x + player.width > h.x + 10 &&
                player.y < h.y + h.height - 10 &&
                player.y + player.height > h.y + 10
            ) {
                triggerGameOver();
            }

            // Remove hazards off screen
            if (h.y > canvas.height) hazards.splice(hIndex, 1);
        });

        requestAnimationFrame(update);
    }

    function triggerGameOver() {
        gameOver = true;
        document.getElementById("gameOver").style.display = "block";
        document.getElementById("finalScore").innerText = score;
        
        // Show Ad Button
        document.getElementById("reviveBtn").style.display = "inline-block";
    }
    
    // Revive Logic (Call this when Ad is done)
    function revivePlayer() {
        gameOver = false;
        document.getElementById("gameOver").style.display = "none";
        hazards = []; // Clear screen
        bullets = [];
        
        // Give immunity on revive too!
        isImmune = true;
        setTimeout(() => { isImmune = false; }, 3000);
        
        update();
    }

    // Start Loop
    update();
</script>
