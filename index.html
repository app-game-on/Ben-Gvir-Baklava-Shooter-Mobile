<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Ben Gvir Shooter - Baklava Arcade Game</title>
    <meta name="description" content="Play Ben Gvir Shooter - The official arcade game. Shoot baklavas, dodge hazards, and compete for the top score!">
    <link rel="icon" type="image/png" href="baklava.png">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; }
        body { overflow: hidden; font-family: sans-serif; background: #1a1410; position: fixed; width: 100%; height: 100%; }
        #gameCanvas { display: block; }
        #loginScreen { position: absolute; inset: 0; background: #1a1410; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        #loginScreen input { padding: 15px; font-size: 18px; border-radius: 8px; margin: 20px 0; width: 80%; max-width: 300px; text-align: center; border: none; }
        #loginScreen button { padding: 15px 40px; font-size: 20px; background: #ffcc00; border: none; border-radius: 8px; font-weight: bold; color: #000; }
        #ui { position: absolute; top: 10px; right: 10px; text-align: right; color: #fff; font-weight: bold; z-index: 10; pointer-events: none; text-shadow: 2px 2px 2px #000; }
        .topBtns { position: absolute; top: 15px; left: 15px; display: flex; gap: 10px; z-index: 50; }
        .controlBtn { width: 45px; height: 45px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; cursor: pointer; }
        #fireBtn { position: absolute; bottom: 40px; left: 25px; width: 95px; height: 95px; border-radius: 50%; background: rgba(255, 68, 68, 0.7); border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; z-index: 15; font-size: 20px; }
        #gameOver, #pauseOverlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #fff; display: none; z-index: 60; background: rgba(0,0,0,0.95); padding: 20px; border-radius: 20px; border: 4px solid #ff4444; width: 90%; max-width: 400px; }
        .leaderboard { width: 100%; margin: 15px 0; border-collapse: collapse; font-size: 16px; }
        .leaderboard td { padding: 8px; border-bottom: 1px solid #333; }
        .gold { color: #ffcc00; font-weight: bold; }
        .actionBtn { margin: 5px; padding: 12px 25px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: inline-block; }
        #retryBtn { background: #ff4444; color: #fff; }
        #resumeBtn { background: #ffcc00; color: #000; }
        #shareBtn { background: #25D366; color: #fff; }
    </style>
</head>
<body>

    <div class="topBtns">
        <div id="muteBtn" class="controlBtn">üîä</div>
        <div id="pauseBtn" class="controlBtn">‚è∏</div>
    </div>

    <div id="loginScreen">
        <h1 style="color:#ffcc00;">BEN GVIR SHOOTER</h1>
        <input type="text" id="usernameInput" placeholder="ENTER NAME..." maxlength="12">
        <button id="startBtn">PLAY GLOBAL</button>
    </div>

    <div id="pauseOverlay">
        <h1 style="color: #ffcc00;">PAUSED</h1>
        <button id="resumeBtn" class="actionBtn">RESUME</button>
    </div>

    <div id="ui">
        SCORE: <span id="score">0</span><br>
        <span id="comboText" style="color:#ffcc00; display:none;">COMBO: x<span id="comboVal">1</span></span><br>
        <span style="color:#ffcc00">AMMO: <span id="ammo">3</span></span>
    </div>
    <div id="fireBtn">FIRE</div>

    <div id="gameOver">
        <h1 style="color: #ff4444;">WASTED</h1>
        <div id="finalScore" style="font-size: 22px; margin: 10px 0;"></div>
        <h3 style="color:#ffcc00;">GLOBAL TOP 5</h3>
        <table class="leaderboard"><tbody id="leaderboardBody"><tr><td>Connecting...</td></tr></tbody></table>
        <div style="display: flex; justify-content: center; flex-wrap: wrap;">
            <button id="retryBtn" class="actionBtn">RETRY</button>
            <button id="shareBtn" class="actionBtn">SHARE SCORE</button>
        </div>
    </div>
    
    <canvas id="gameCanvas"></canvas>
    
    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz3JYh1ebRrvFZP0zNVLRcjtfv7wi7dZxMCb0uNOvtj7cSyE8FQVz9Dp_KOzFfg4H45/exec";
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const headImg = new Image(); headImg.src = 'photo1.png';
        const baklavaImg = new Image(); baklavaImg.src = 'baklava.png';
        const bombImg = new Image(); bombImg.src = 'bomb.png';
        const arabImg = new Image(); arabImg.src = 'arab.png';
        const failSound = new Audio('fail_sound.mp3');

        let isMuted = false, isPaused = false;
        let username = "", gameRunning = false, loopId = null;
        let score = 0, ammo = 3, totalFrames = 0, flashOpacity = 0, shake = 0;
        let combo = 0, comboTimer = 0;
        let hazards = [], baklavas = [], particles = [], moveTarget = null;
        const player = { x: 0, y: 0, walkCycle: 0 };
        const HAZARD_SIZE = 90; // Decreased by 25% from 120px

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            player.x = canvas.width / 2; player.y = canvas.height * 0.7;
        }
        window.addEventListener('resize', resize);
        resize();

        document.getElementById('muteBtn').onclick = (e) => {
            isMuted = !isMuted;
            document.getElementById('muteBtn').innerText = isMuted ? "üîá" : "üîä";
            e.stopPropagation();
        };

        function togglePause() {
            if (!gameRunning) return;
            isPaused = !isPaused;
            document.getElementById('pauseOverlay').style.display = isPaused ? 'block' : 'none';
            document.getElementById('pauseBtn').innerText = isPaused ? "‚ñ∂" : "‚è∏";
        }
        document.getElementById('pauseBtn').onclick = (e) => { togglePause(); e.stopPropagation(); };
        document.getElementById('resumeBtn').onclick = togglePause;

        document.getElementById('shareBtn').onclick = () => {
            const text = `I just scored ${score} in Ben Gvir Shooter! Can you beat me?`;
            const url = "https://bengvirshooter.com";
            if (navigator.share) {
                navigator.share({ title: 'Ben Gvir Shooter', text: text, url: url });
            } else {
                window.open(`https://wa.me/?text=${encodeURIComponent(text + " " + url)}`, '_blank');
            }
        };

        async function syncGlobalScores(name, finalScore) {
            const body = document.getElementById('leaderboardBody');
            try {
                const response = await fetch(`${SCRIPT_URL}?name=${encodeURIComponent(name)}&score=${finalScore}`);
                const data = await response.json();
                body.innerHTML = "";
                data.forEach((entry, i) => {
                    body.innerHTML += `<tr class="${i === 0 ? 'gold' : ''}"><td>#${i+1}</td><td>${entry[0]}</td><td>${entry[1]}</td></tr>`;
                });
            } catch (err) { body.innerHTML = "<tr><td>Error syncing.</td></tr>"; }
        }

        function createExplosion(x, y, count = 15, color = '#f40') {
            for(let i=0; i<count; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random()-0.5)*15,
                    vy: (Math.random()-0.5)*15,
                    life: 30,
                    size: Math.random()*5 + 2,
                    color: i%2===0 ? color : '#fc0'
                });
            }
        }

        function runGame() {
            if (loopId) cancelAnimationFrame(loopId);
            gameRunning = true; isPaused = false;
            score = 0; ammo = 3; totalFrames = 0; flashOpacity = 0; shake = 0;
            combo = 0; comboTimer = 0;
            hazards = []; baklavas = []; particles = [];
            document.getElementById('score').innerText = "0";
            document.getElementById('ammo').innerText = "3";
            document.getElementById('comboText').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('pauseOverlay').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'none';
            gameLoop();
        }

        document.getElementById('startBtn').onclick = () => {
            username = document.getElementById('usernameInput').value.trim().toUpperCase() || "PLAYER";
            runGame();
        };
        document.getElementById('retryBtn').onclick = runGame;

        canvas.addEventListener('touchstart', (e) => { if(!isPaused) moveTarget = { x: e.touches[0].clientX, y: e.touches[0].clientY }; });
        canvas.addEventListener('touchmove', (e) => { if(!isPaused) { e.preventDefault(); moveTarget = { x: e.touches[0].clientX, y: e.touches[0].clientY }; } }, {passive: false});
        canvas.addEventListener('touchend', () => { moveTarget = null; });

        document.getElementById('fireBtn').addEventListener('touchstart', (e) => {
            e.stopPropagation();
            if (gameRunning && !isPaused && ammo > 0) {
                baklavas.push({ x: player.x, y: player.y - 20 });
                ammo--; document.getElementById('ammo').innerText = ammo;
            }
        });

        function triggerDeath() {
            gameRunning = false; flashOpacity = 1.0; shake = 30;
            if(!isMuted) failSound.play().catch(()=>{});
            createExplosion(player.x, player.y, 80);
            document.getElementById('finalScore').innerText = "SCORE: " + score;
            document.getElementById('gameOver').style.display = 'block';
            syncGlobalScores(username, score);
        }

        function update() {
            if (isPaused) return;
            if (shake > 0) shake *= 0.85;
            if (flashOpacity > 0) flashOpacity -= 0.04;
            if (comboTimer > 0) comboTimer--; else { combo = 0; document.getElementById('comboText').style.display = 'none'; }

            particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.life--; if (p.life <= 0) particles.splice(i, 1); });
            if (!gameRunning) return;
            
            totalFrames++;
            if (totalFrames % 360 === 0) { ammo++; document.getElementById('ammo').innerText = ammo; }

            if (moveTarget) {
                player.x += (moveTarget.x - player.x) * 0.45;
                player.y += (moveTarget.y - 40 - player.y) * 0.45;
                player.walkCycle += 0.35;
            }

            let diffMult = Math.pow(1.25, Math.floor(score / 500));
            let spawnRate = Math.max(7, Math.floor(22 / diffMult));

            if (totalFrames % spawnRate === 0) {
                hazards.push({ 
                    x: Math.random() * (canvas.width - HAZARD_SIZE), 
                    y: -150, 
                    type: Math.random() > 0.5 ? 'bomb' : 'doc' 
                });
            }

            hazards.forEach((h, i) => {
                h.y += 5.2 + (score / 2500);
                // Unified Collision Check for 90px
                if (Math.abs(h.x + HAZARD_SIZE/2 - player.x) < 55 && Math.abs(h.y + HAZARD_SIZE/2 - player.y) < 70) triggerDeath();
                if (h.y > canvas.height) { hazards.splice(i, 1); score += 10; }
            });

            baklavas.forEach((b, bi) => {
                b.y -= 12;
                hazards.forEach((h, mi) => {
                    // Impact Check for 90px
                    if (Math.abs(b.x - (h.x + HAZARD_SIZE/2)) < 50 && Math.abs(b.y - (h.y + HAZARD_SIZE/2)) < 50) { 
                        createExplosion(h.x + HAZARD_SIZE/2, h.y + HAZARD_SIZE/2, 20);
                        hazards.splice(mi, 1); baklavas.splice(bi, 1); 
                        combo++; comboTimer = 180; shake = 10; score += (100 * combo);
                        document.getElementById('comboVal').innerText = combo;
                        document.getElementById('comboText').style.display = 'block';
                    }
                });
                if (b.y < -20) { baklavas.splice(bi, 1); combo = 0; }
            });
            document.getElementById('score').innerText = score;
        }

        function draw() {
            ctx.save();
            if (shake > 1) ctx.translate(Math.random()*shake - shake/2, Math.random()*shake - shake/2);
            
            let redInt = Math.min(100, score / 100);
            ctx.fillStyle = `rgb(${61 + redInt}, 51, 41)`; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (gameRunning || isPaused) {
                ctx.drawImage(headImg, player.x - 25, player.y - 25, 50, 50);
                const sw = Math.sin(player.walkCycle) * 18;
                ctx.strokeStyle = '#E6B5AC'; ctx.lineWidth = 5; ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(player.x, player.y + 25); ctx.lineTo(player.x, player.y + 60);
                ctx.moveTo(player.x, player.y + 40); ctx.lineTo(player.x - 25, player.y + 50 + sw);
                ctx.moveTo(player.x, player.y + 40); ctx.lineTo(player.x + 25, player.y + 50 - sw);
                ctx.moveTo(player.x, player.y + 60); ctx.lineTo(player.x - 15, player.y + 90 + sw);
                ctx.moveTo(player.x, player.y + 60); ctx.lineTo(player.x + 15, player.y + 90 - sw);
                ctx.stroke();
            }
            hazards.forEach(h => {
                if(h.type === 'bomb') {
                    ctx.drawImage(bombImg, h.x, h.y, HAZARD_SIZE, HAZARD_SIZE);
                } else {
                    ctx.drawImage(arabImg, h.x, h.y, HAZARD_SIZE, HAZARD_SIZE);
                }
            });
            baklavas.forEach(b => ctx.drawImage(baklavaImg, b.x - 22, b.y - 22, 45, 45));
            particles.forEach(p => { ctx.fillStyle = p.color; ctx.globalAlpha = p.life / 30; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill(); });
            ctx.restore();
            if (flashOpacity > 0) { ctx.fillStyle = `rgba(255,255,255,${flashOpacity})`; ctx.fillRect(0,0,canvas.width, canvas.height); }
        }

        function gameLoop() { update(); draw(); loopId = requestAnimationFrame(gameLoop); }
    </script>
</body>
</html>
